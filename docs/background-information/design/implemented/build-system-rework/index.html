<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-background-information/design/implemented/build-system-rework">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">RFC: Ninja-based Builds | Evo.lua</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://evo-lua.github.io/docs/background-information/design/implemented/build-system-rework"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RFC: Ninja-based Builds | Evo.lua"><meta data-rh="true" name="description" content="This document lists reasons for replacing Luvi&#x27;s CMake build system"><meta data-rh="true" property="og:description" content="This document lists reasons for replacing Luvi&#x27;s CMake build system"><link data-rh="true" rel="icon" href="/img/caterpillar.png"><link data-rh="true" rel="canonical" href="https://evo-lua.github.io/docs/background-information/design/implemented/build-system-rework"><link data-rh="true" rel="alternate" href="https://evo-lua.github.io/docs/background-information/design/implemented/build-system-rework" hreflang="en"><link data-rh="true" rel="alternate" href="https://evo-lua.github.io/docs/background-information/design/implemented/build-system-rework" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.823e5978.css">
<link rel="preload" href="/assets/js/runtime~main.6e8872a6.js" as="script">
<link rel="preload" href="/assets/js/main.5785e466.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/caterpillar.png" alt="Evo.lua Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/caterpillar.png" alt="Evo.lua Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Evo.lua</b></a><a class="navbar__item navbar__link" href="/docs">Documentation</a><a class="navbar__item navbar__link" href="/docs/category/api">API Overview</a><a class="navbar__item navbar__link" href="/docs/security-policy">Security Policy</a><a class="navbar__item navbar__link" href="/docs/contributing">Contributing</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/evo-lua" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Documentation Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/getting-started">Getting Started</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/how-to-guides">How-to Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;How-to Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/background-information">Background Information</a><button aria-label="Toggle the collapsible sidebar category &#x27;Background Information&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/design-documents">Design Documents</a><button aria-label="Toggle the collapsible sidebar category &#x27;Design Documents&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/drafts">Drafts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Drafts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/implemented">Implemented</a><button aria-label="Toggle the collapsible sidebar category &#x27;Implemented&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/background-information/design/implemented/build-system-rework">RFC: Ninja-based Builds</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/background-information/design/implemented/code-conventions">RFC: Code Conventions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/background-information/design/implemented/event-handling">RFC: Event Handling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/background-information/design/implemented/testing-architecture">RFC: Smoke Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/background-information/design/implemented/unit-test-runner">RFC: Builtin Test Runner</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/background-information/design/template">Template</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/luajit-notes">LuaJIT Notes</a><button aria-label="Toggle the collapsible sidebar category &#x27;LuaJIT Notes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/background-information/the-evo-philosophy">The Evo Philosophy</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/references">References</a><button aria-label="Toggle the collapsible sidebar category &#x27;References&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/security-policy">Security Policy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/contributing">Contributing</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/background-information"><span itemprop="name">Background Information</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/design-documents"><span itemprop="name">Design Documents</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/implemented"><span itemprop="name">Implemented</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RFC: Ninja-based Builds</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>RFC: Ninja-based Builds</h1><p>This document lists reasons for replacing Luvi&#x27;s CMake build system</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation">​</a></h2><p>Evo-Luvi is based on Luvi, and as such uses the same build system (based on <a href="https://cmake.org/" target="_blank" rel="noopener noreferrer">CMake</a>). Multiple issues have surfaced:</p><ul><li>CMake adds an exceeding amount of complexity and an entirely new (poorly-designed) language to the stack</li><li>Integrating external dependencies in the build process has proven to be a huge pain in at least some cases</li><li>The existing build system accounts for many unsupported use cases, unnecessarily increasing complexity further</li><li>It uses version 2 of CMake, which makes the code difficult to maintain and extend, or migrate to &quot;modern&quot; CMake</li><li>Builds using WSL can randomly fail with segmentation faults that I&#x27;d rather not spend more time debugging</li><li>CMake builds also frequently fail for obscure reasons, don&#x27;t build what they&#x27;re supposed to, or rebuild too many things <sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup></li><li>Speaking of which, debugging CMake files is not fun (it&#x27;s not a fully-fledged language, with poor tooling)</li><li>Builds are somewhat slow when using the standard CMake generators, and Ninja support is experimental</li><li>In fact, the Ninja build files that CMake creates are huge and complicated, which doesn&#x27;t bode well for their quality</li><li>The ability to create VS solutions (and use the VS debugger) aren&#x27;t very valuable, so I can do without <sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup></li></ul><p>After spending obscene amounts of time battling build-related problems, it may be time for a change of scenery.</p><hr><p><sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> <em>Perhaps that&#x27;s a configuration issue, but given the state of the CMake &quot;documentation&quot; I&#x27;d rather not look into it further.</em></p><p><sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup> <em>This is mainly because the C code involved consists largely of glue code and Lua bindings, which is mostly boilerplate.</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">​</a></h2><p>A reimagined build system for the runtime should fulfill the following requirements:</p><ul><li>Anyone familiar with Lua (and possibly C/C++) should be able to make changes to the build system easily</li><li>Those familiar with standard Makefile builds (widely used in the Unix world) should experience less friction</li><li>Support for any optional configuration, toolchains etc. should be dropped to minimize the maintenance burden</li></ul><p>Since Makefiles aren&#x27;t ideal for reducing build times, Ninja build files might be created from within Lua scripts.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-decisions">Design Decisions<a href="#design-decisions" class="hash-link" aria-label="Direct link to Design Decisions" title="Direct link to Design Decisions">​</a></h2><p>To cut down on accidental complexity, the build system should only support a minimal and &quot;recommended&quot; configuration:</p><ul><li>One &quot;blessed&quot; configuration, building the runtime as an executable that&#x27;s linked with a minimal set of libraries</li><li>Only the GNU compiler toolchain should be supported, since it&#x27;s free software available on all relevant systems</li><li>Incremental builds should be handled by Ninja, with support for gmake, MSVC and other CMake generators dropped</li><li>The build configuration (<code>ninja.build</code>) should be auto-generated in Lua, which is trivial given the restrictions above</li><li>Third-party libraries may use Makefiles, CMake or any other build script that can be integrated via ninja commands</li><li>Build tools must function with only standard LuaJIT functionality, i.e., be usable after compiling <code>luajit</code> and nothing else</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="evaluation">Evaluation<a href="#evaluation" class="hash-link" aria-label="Direct link to Evaluation" title="Direct link to Evaluation">​</a></h2><p>This design should cover all of the requirements:</p><ul><li>The build configuration can be trivially changed by anyone with basic Lua knowledge</li><li>Builds are fast thanks to relying on Ninja&#x27;s incremental build functionality (same or better as CMake)</li><li>The <code>ninja.build</code> files can be understood by anyone familiar with Makefiles if low-level debugging is required</li><li>Compatibility with third party libraries is unaffected (ninja can easily build them by invoking <code>cmake</code> or <code>make</code>)</li><li>More complex configuration needs that may arise in the future can be scripted with maximum flexibility</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alternatives">Alternatives<a href="#alternatives" class="hash-link" aria-label="Direct link to Alternatives" title="Direct link to Alternatives">​</a></h2><p>The following alternatives have been considered and (at least partially) explored before settling on a decision:</p><ul><li>Attempt to migrate the CMake build system to &quot;modern&quot; CMake and prune unused features (still a giant headache)</li><li>Use another established (Lua-based) build system, like xmake or premake (only alleviates the language issue)</li><li>Use another established (non-Lua-based) build system, like meson (Python-based syntax, limiting language)</li><li>Move to using Ninja build files directly (efficient, but difficult to maintain as they&#x27;re glorified makefiles)</li><li>Build with <a href="https://ziglang.org/" target="_blank" rel="noopener noreferrer">zig</a>, which has been suggested by the luvi authors (requires rewriting external build scripts; not Lua)</li><li>Use regular build scripts (cannot do incremental builds, which significantly slows down development)</li></ul><p>None of these options really seems all that appealing, as they don&#x27;t fully solve the outlined problems.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="disclaimer">Disclaimer<a href="#disclaimer" class="hash-link" aria-label="Direct link to Disclaimer" title="Direct link to Disclaimer">​</a></h2><p>For a regular C library, CMake would be more valuable due to its status as de-facto standard. In this case, there&#x27;s barely any C code (that isn&#x27;t glue) and using the runtime as a library makes no sense, so the headaches really aren&#x27;t worth it.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/evo-lua/evo-lua.github.io/edit/main/docs/background-information/design/implemented/build-system-rework.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/implemented"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Implemented</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/background-information/design/implemented/code-conventions"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RFC: Code Conventions</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#design-decisions" class="table-of-contents__link toc-highlight">Design Decisions</a></li><li><a href="#evaluation" class="table-of-contents__link toc-highlight">Evaluation</a></li><li><a href="#alternatives" class="table-of-contents__link toc-highlight">Alternatives</a></li><li><a href="#disclaimer" class="table-of-contents__link toc-highlight">Disclaimer</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021-2023 · Evo.lua authors and contributors</div></div></div></footer></div>
<script src="/assets/js/runtime~main.6e8872a6.js"></script>
<script src="/assets/js/main.5785e466.js"></script>
</body>
</html>